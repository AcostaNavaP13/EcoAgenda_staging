<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoAgenda - Gesti√≥n de Recolecciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .modal-overlay, .dropdown-menu { animation: fadeIn 0.2s ease-out; }
        .modal-content { animation: fadeInScale 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .day-column::-webkit-scrollbar, .table-container::-webkit-scrollbar { width: 8px; }
        .day-column::-webkit-scrollbar-track, .table-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .day-column::-webkit-scrollbar-thumb, .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .day-column::-webkit-scrollbar-thumb:hover, .table-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .is-today { background-color: #eef2ff !important; border: 1px solid #c7d2fe; }
        .is-today .date-number { color: #4f46e5; font-weight: 900; }
        #add-new-btn-floating { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 30; }
        #toast-container { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column-reverse; gap: 0.5rem; align-items: center; }
        #profile-login-overlay { animation: fadeIn 0.3s ease-in-out; }
        
        /* Drag and Drop Styles */
        .month-event.dragging { opacity: 0.5; background: #e0e7ff; }
        .day-cell-month.drag-over { background-color: #dbeafe !important; border: 2px dashed #60a5fa; }
        
        @media print {
            body * { visibility: hidden; }
            #main-content, #main-content * { visibility: visible; }
            #main-content { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="profile-login-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 z-50 flex justify-center items-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <img src="https://ecofibras.com.mx/wp-content/uploads/2021/05/logo-ecofibras.png" alt="Logo Ecofibras" class="h-12 mx-auto mb-4" onerror="this.src='https://placehold.co/200x50/ffffff/9ca3af?text=EcoFibras'">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Bienvenido a EcoAgenda</h2>
            <p class="text-gray-600 mb-6">Ingresa tu c√≥digo de tienda para continuar.</p>
            <form id="profile-login-form">
                <input type="text" id="profile-code-input" placeholder="Ej: TIENDA-001" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg text-center" required>
                <p id="loading-message" class="text-indigo-600 mt-4 h-6"></p>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 mt-4">Acceder</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <button id="add-new-btn-floating" class="flex items-center bg-indigo-600 text-white font-bold py-3 px-3 rounded-full hover:bg-indigo-700 transition duration-300 shadow-lg no-print">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            <span class="ml-2 hidden sm:inline">Agregar</span>
        </button>
        <header class="bg-white shadow-md sticky top-0 z-20 no-print">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex flex-col items-start">
                       <img src="https://ecofibras.com.mx/wp-content/uploads/2021/05/logo-ecofibras.png" alt="Logo Ecofibras" class="h-10" onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                       <div class="hidden flex-col items-start" style="display: none;">
                           <span class="text-2xl font-bold text-gray-800">EcoAgenda</span>
                           <span class="text-xs text-gray-500 opacity-75 -mt-1">by Adhal Cabrera</span>
                       </div>
                    </div>
                   <div class="flex items-center gap-4">
                       <div class="text-right">
                           <p class="text-sm font-medium text-gray-800" id="profile-display">Perfil: <span class="font-bold"></span></p>
                           <button id="logout-btn" class="text-xs text-indigo-600 hover:underline">Cambiar Perfil</button>
                       </div>
                        <nav id="main-nav" class="flex space-x-2 sm:space-x-4">
                            <button data-view="agenda" class="nav-btn px-3 py-2 rounded-md text-sm font-medium bg-indigo-600 text-white">Agenda</button>
                            <button data-view="gestion" class="nav-btn px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-200">Gesti√≥n</button>
                            <button data-view="reportes" class="nav-btn px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-200">Reportes</button>
                        </nav>
                   </div>
                </div>
            </div>
        </header>
        <main id="main-content" class="container mx-auto p-4 sm:p-6 lg:p-8"></main>
    </div>
    
    <div id="modal-container"></div>
    <div id="toast-container"></div>
    
    <input type="file" id="import-clients-input" class="hidden" accept=".csv">
    <input type="file" id="import-operators-input" class="hidden" accept=".csv">
    <input type="file" id="import-agenda-input" class="hidden" accept=".csv">

    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, setLogLevel, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAidNDyyV_bM9X0IxulxPa3iTMwnnW81XE",
            authDomain: "ecoagenda-by-adhal.firebaseapp.com",
            projectId: "ecoagenda-by-adhal",
            storageBucket: "ecoagenda-by-adhal.firebasestorage.app",
            messagingSenderId: "299756391530",
            appId: "1:299756391530:web:e35eb9428045675d684e13",
            measurementId: "G-MR6NK54GEX"
        };
        
        // --- App UI Elements ---
        const loadingMessage = document.getElementById('loading-message');

        try {
            // --- 2. Initialize Firebase ---
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            setLogLevel('debug'); // Enable detailed logs for debugging
            console.log("‚úÖ [1/5] Firebase App inicializada correctamente.");
            loadingMessage.textContent = "Servicios conectados...";

            // --- App Logic ---
            document.addEventListener('DOMContentLoaded', () => {
                const appId = firebaseConfig.projectId;
                let unsubscribe;
                
                const profileLoginForm = document.getElementById('profile-login-form');
                const appContainer = document.getElementById('app-container');
                const profileLoginOverlay = document.getElementById('profile-login-overlay');
                const profileDisplay = document.getElementById('profile-display').querySelector('span');
                const logoutBtn = document.getElementById('logout-btn');
                const mainContent = document.getElementById('main-content');
                const modalContainer = document.getElementById('modal-container');

                let state = {};
                let activeCharts = {};
                let isAuthReady = false;

                function initializeEmptyState(profileId) {
                    return {
                        currentView: 'agenda', gestionView: 'clientes', calendarView: 'week',
                        currentDate: new Date(), clients: [], operators: [], events: [],
                        editingItem: null, reportDateRange: 'last7days', reportCustomStartDate: '',
                        reportCustomEndDate: '', reportTablePage: 1, reportTableRowsPerPage: 10,
                        currentProfile: profileId,
                    };
                }
                
                async function updateFirestoreState() {
                    if (!state.currentProfile || !auth.currentUser) return;
                    console.log(`üîÑ Guardando estado en Firestore para perfil: ${state.currentProfile}`);
                    const stateToSave = {
                        ...state,
                        currentDate: state.currentDate.toISOString(),
                        events: state.events.map(e => ({...e, start: e.start.toISOString()})),
                    };
                    delete stateToSave.currentProfile;
                    try {
                        const docRef = doc(db, "artifacts", appId, "public/data/profiles", state.currentProfile);
                        await setDoc(docRef, stateToSave, { merge: true });
                        console.log("‚úÖ Estado guardado con √©xito.");
                    } catch (error) {
                        console.error("‚ùå Error al guardar estado en Firestore: ", error);
                        showToast("Error al guardar los datos.", "error");
                    }
                }
                
                function setupRealtimeListener(profileId) {
                    if (unsubscribe) unsubscribe();
                    console.log(`üéß [4/5] Configurando listener para perfil: ${profileId}`);
                    loadingMessage.textContent = `Cargando perfil ${profileId}...`;
                    const docRef = doc(db, "artifacts", appId, "public/data/profiles", profileId);
                    
                    unsubscribe = onSnapshot(docRef, (docSnapshot) => {
                        if (docSnapshot.exists()) {
                            console.log("‚úÖ [5/5] Datos recibidos de Firestore.");
                            const data = docSnapshot.data();
                            data.currentDate = new Date(data.currentDate);
                            data.events = data.events.map(e => ({...e, start: new Date(e.start)}));
                            state = { ...initializeEmptyState(profileId), ...data, currentProfile: profileId };
                        } else {
                            console.warn("‚ö†Ô∏è  [5/5] El perfil no existe. Creando uno nuevo en Firestore.");
                            state = initializeEmptyState(profileId);
                            updateFirestoreState(); // Create the document
                        }
                        
                        profileLoginOverlay.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        loadingMessage.textContent = "";
                        profileDisplay.textContent = profileId;
                        render();
                    }, (error) => {
                        console.error("‚ùå [5/5] Error en el listener de Firestore:", error);
                        showToast("Error de conexi√≥n con la base de datos.", "error");
                        loadingMessage.textContent = "Error al leer datos.";
                         if(error.code === 'permission-denied') {
                             showToast("Error: Permiso denegado. Revisa las reglas de seguridad de Firestore.", "error");
                             loadingMessage.textContent = "Error de permisos en la base de datos.";
                         }
                    });
                }
                
                // --- 3. Authentication Flow ---
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log(`‚úÖ [2/5] Autenticaci√≥n exitosa (an√≥nima). UID: ${user.uid}`);
                        isAuthReady = true;
                        loadingMessage.textContent = "Autenticaci√≥n lista.";
                    } else if (!isAuthReady) {
                        console.log("‚è≥ [2/5] Intentando autenticaci√≥n an√≥nima...");
                        loadingMessage.textContent = "Autenticando...";
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                           console.error("‚ùå [2/5] Error de autenticaci√≥n an√≥nima:", error);
                           loadingMessage.textContent = "Error de autenticaci√≥n.";
                           showToast("Error de API Key. Revisa la configuraci√≥n.", "error");
                        }
                    }
                });

                profileLoginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (!isAuthReady) {
                        showToast("Esperando autenticaci√≥n... Por favor, espera un momento.", "error");
                        console.warn("‚ö†Ô∏è Intento de login antes de que la autenticaci√≥n estuviera lista.");
                        return;
                    }
                    const profileCode = document.getElementById('profile-code-input').value.trim().toUpperCase();
                    if (profileCode) {
                        console.log(`üöÄ [3/5] Iniciando carga para perfil: ${profileCode}`);
                        setupRealtimeListener(profileCode);
                    }
                });

                logoutBtn.addEventListener('click', () => {
                    renderConfirmModal('¬øCambiar de Perfil?', 'Esto recargar√° la p√°gina para que puedas ingresar un nuevo c√≥digo de tienda.', () => {
                        if(unsubscribe) unsubscribe();
                        window.location.reload();
                    });
                });
                
                const isToday = (date) => new Date().toDateString() === date.toDateString();
                const isSameDay = (d1, d2) => d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
                const formatDateForGoogle = (date) => date.toISOString().replace(/-|:|\.\d{3}/g, '');
                const formatICSDate = (date) => date.toISOString().replace(/-|:|\.\d{3}/g, '').slice(0, 15) + 'Z';
                
                function showToast(message, type = 'success') {
                    const toastContainer = document.getElementById('toast-container');
                    const toast = document.createElement('div');
                    toast.className = `p-4 rounded-lg text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} shadow-lg text-lg`;
                    toast.textContent = message;
                    toastContainer.prepend(toast);
                    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 7000);
                }

                function render() {
                    if (!state.currentProfile) return;
                    Object.values(activeCharts).forEach(chart => chart.destroy());
                    activeCharts = {};
                    switch (state.currentView) {
                        case 'agenda': renderAgendaView(); break;
                        case 'gestion': renderGestionView(); break;
                        case 'reportes': renderReportsView(); break;
                    }
                }

                function renderAgendaView() {
                    const headerHTML = `<div class="flex items-center justify-between mb-4 px-2 flex-wrap gap-4 no-print"><div class="relative inline-block text-left" id="io-dropdown-container"><div><button type="button" data-action="toggle-io-dropdown" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Importar / Exportar<svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button></div><div id="io-dropdown-menu" class="origin-top-left absolute left-0 mt-2 w-80 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10" role="menu" aria-orientation="vertical"><div class="py-1" role="none"><span class="block px-4 py-2 text-xs text-gray-400 uppercase">Exportar</span><div class="relative group"><a href="#" data-action="export-agenda-csv" class="flex items-center justify-between text-gray-700 w-full px-4 py-2 text-sm hover:bg-gray-100" role="menuitem"><span>Exportar a CSV</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></a><div class="absolute left-full top-0 ml-2 w-64 p-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-20">Exporta todos los eventos de la agenda a un archivo CSV.</div></div><div class="relative group"><a href="#" data-action="export-agenda-ics" class="flex items-center justify-between text-gray-700 w-full px-4 py-2 text-sm hover:bg-gray-100" role="menuitem"><span>Exportar a Calendario (.ics)</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></a><div class="absolute left-full top-0 ml-2 w-64 p-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-20">Genera un archivo compatible con Google Calendar, Outlook, etc.</div></div><div class="relative group"><a href="#" data-action="print-view" class="flex items-center justify-between text-gray-700 w-full px-4 py-2 text-sm hover:bg-gray-100" role="menuitem"><span>Imprimir Vista</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></a><div class="absolute left-full top-0 ml-2 w-64 p-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-20">Abre el di√°logo de impresi√≥n para la vista de calendario actual.</div></div><div class="border-t border-gray-100 my-1"></div><span class="block px-4 py-2 text-xs text-gray-400 uppercase">Importar</span><div class="relative group"><a href="#" data-action="download-general-template" class="flex items-center justify-between text-gray-700 w-full px-4 py-2 text-sm hover:bg-gray-100" role="menuitem"><span>Descargar Plantilla General</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></a><div class="absolute left-full top-0 ml-2 w-64 p-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-20">Plantilla para cargar eventos. Si el cliente u operador no existe, ser√° creado.</div></div><div class="relative group"><a href="#" data-action="import-agenda" class="flex items-center justify-between text-gray-700 w-full px-4 py-2 text-sm hover:bg-gray-100" role="menuitem"><span>Importar Plantilla General</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></a><div class="absolute left-full top-0 ml-2 w-64 p-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-20">Abre el explorador de archivos para que selecciones una plantilla CSV.</div></div></div></div></div><div class="flex items-center space-x-1"><button data-action="prev-period" class="p-2 rounded-md hover:bg-gray-100 text-gray-600">&lt;</button><button data-action="today" class="px-3 py-1.5 rounded-md text-sm font-semibold border border-gray-300">Hoy</button><button data-action="next-period" class="p-2 rounded-md hover:bg-gray-100 text-gray-600">&gt;</button></div><div class="flex items-center space-x-1 border border-gray-300 rounded-lg p-0.5"><button data-calendar-view="day" class="calendar-view-btn px-2 py-1 text-sm rounded-md ${state.calendarView === 'day' ? 'bg-indigo-600 text-white' : 'text-gray-600'}">D√≠a</button><button data-calendar-view="week" class="calendar-view-btn px-2 py-1 text-sm rounded-md ${state.calendarView === 'week' ? 'bg-indigo-600 text-white' : 'text-gray-600'}">Semana</button><button data-calendar-view="month" class="calendar-view-btn px-2 py-1 text-sm rounded-md ${state.calendarView === 'month' ? 'bg-indigo-600 text-white' : 'text-gray-600'}">Mes</button></div></div>`;
                    let calendarHTML = '';
                    if (state.calendarView === 'day') calendarHTML = renderDayView(); else if (state.calendarView === 'week') calendarHTML = renderWeekView(); else calendarHTML = renderMonthView();
                    mainContent.innerHTML = `<div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">${headerHTML}${calendarHTML}</div>`;
                }

                function renderDayView() {
                    const day = state.currentDate; const dayEvents = state.events.filter(e => isSameDay(e.start, day)); const todayClass = isToday(day) ? 'is-today' : '';
                    return `<div class="grid grid-cols-1 gap-px bg-gray-200 border border-gray-200"><div class="bg-gray-50 p-2 flex flex-col min-h-[60vh] ${todayClass}"><div class="text-center mb-2"><p class="font-semibold text-gray-700 text-sm">${day.toLocaleDateString('es-ES', { weekday: 'long' })}</p><p class="date-number font-bold text-2xl">${day.getDate()}</p></div><div class="flex-grow space-y-3 overflow-y-auto bg-white p-3 rounded-md day-column">${dayEvents.length > 0 ? dayEvents.sort((a,b) => a.start - b.start).map(renderEventCard).join('') : `<p class="text-center text-gray-500 mt-10">No hay eventos.</p>`}</div><button data-action="add-event" data-date="${day.toISOString()}" class="mt-2 w-full text-center text-indigo-600 hover:text-indigo-800 text-sm font-semibold p-1 rounded-md hover:bg-indigo-50 transition-colors no-print">+ Agregar</button></div></div>`;
                }

                function renderWeekView() {
                    const startOfWeek = new Date(state.currentDate); const dayOfWeek = startOfWeek.getDay(); const diff = startOfWeek.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); startOfWeek.setDate(diff); let weekHTML = '';
                    for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek); day.setDate(startOfWeek.getDate() + i); const dayEvents = state.events.filter(e => isSameDay(e.start, day)); const todayClass = isToday(day) ? 'is-today' : '';
                        weekHTML += `<div class="bg-gray-50 p-2 min-h-[500px] flex flex-col ${todayClass}"><div class="text-center mb-2"><p class="font-semibold text-gray-700 text-sm">${day.toLocaleDateString('es-ES', { weekday: 'short' })}</p><p class="date-number font-bold text-lg">${day.getDate()}</p></div><div class="flex-grow space-y-2 overflow-y-auto bg-white p-2 rounded-md day-column">${dayEvents.length > 0 ? dayEvents.sort((a,b) => a.start - b.start).map(renderEventCard).join('') : ''}</div><button data-action="add-event" data-date="${day.toISOString()}" class="mt-2 w-full text-center text-indigo-600 hover:text-indigo-800 text-sm font-semibold p-1 rounded-md hover:bg-indigo-50 transition-colors no-print">+ Agregar</button></div>`;
                    }
                    return `<div class="grid grid-cols-1 md:grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden">${weekHTML}</div>`;
                }

                function renderMonthView() {
                    const date = state.currentDate; const year = date.getFullYear(); const month = date.getMonth(); const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const daysInMonth = lastDay.getDate(); let startDayOfWeek = firstDay.getDay(); startDayOfWeek = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;
                    let monthHTML = '<div class="grid grid-cols-7 gap-px text-center text-xs font-bold uppercase text-gray-500 py-2"><div class="py-2">Lu</div><div class="py-2">Ma</div><div class="py-2">Mi</div><div class="py-2">Ju</div><div class="py-2">Vi</div><div class="py-2">Sa</div><div class="py-2">Do</div></div>';
                    monthHTML += `<div class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden">`;
                    for (let i = 0; i < startDayOfWeek; i++) { monthHTML += `<div class="bg-gray-100"></div>`; }
                    for (let i = 1; i <= daysInMonth; i++) {
                        const dayDate = new Date(year, month, i); const dayEvents = state.events.filter(e => isSameDay(e.start, dayDate)); const todayClass = isToday(dayDate) ? 'is-today' : 'bg-white';
                        monthHTML += `<div class="day-cell-month ${todayClass} p-1 min-h-[120px] flex flex-col text-sm" data-date="${dayDate.toISOString()}"><span class="font-semibold self-center">${i}</span><div class="flex-grow overflow-y-auto text-left space-y-1 mt-1">${dayEvents.map(e => { const clientName = state.clients.find(c => c.id === e.clientId)?.name || 'Evento'; return `<div data-event-id="${e.id}" draggable="true" class="flex items-center justify-between cursor-grab month-event text-xs p-1 rounded ${e.type === 'recoleccion' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}"><span data-action="edit-event" data-event-id="${e.id}" class="truncate flex-grow">${clientName}</span><button data-action="delete-event-month" data-event-id="${e.id}" title="Eliminar este evento" class="ml-1 text-red-500 hover:text-red-700 p-0.5 rounded-full hover:bg-red-100 font-bold">&times;</button></div>`; }).join('')}</div><button data-action="add-event" data-date="${dayDate.toISOString()}" class="text-indigo-500 text-lg font-bold self-center no-print mt-auto">+</button></div>`;
                    }
                    monthHTML += `</div>`; return monthHTML;
                }
                
                function renderEventCard(event) {
                    const client = state.clients.find(c => c.id === event.clientId);
                    const operator = state.operators.find(o => o.id === event.operatorId);
                    const cardColor = event.type === 'recoleccion' ? 'border-l-4 border-blue-500' : 'border-l-4 border-green-500';

                    return `
                        <div class="p-3 rounded-lg shadow-sm ${cardColor} bg-white relative group text-sm">
                            <div class="absolute top-2 right-2 flex flex-col items-center space-y-1 opacity-0 group-hover:opacity-100 transition-opacity z-10 no-print">
                                ${client?.notes ? `<button data-action="show-notes" data-client-id="${client.id}" title="Ver notas del cliente" class="p-1 bg-white rounded-full text-gray-600 hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>` : ''}
                                <button data-action="add-to-calendar" data-event-id="${event.id}" title="Agregar a Google Calendar" class="p-1 bg-white rounded-full text-green-600 hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v-4m-2 2h4" /></svg></button>
                                <button data-action="edit-event" data-event-id="${event.id}" title="Editar" class="p-1 bg-white rounded-full text-blue-600 hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button>
                                <button data-action="delete-event" data-event-id="${event.id}" title="Eliminar" class="p-1 bg-white rounded-full text-red-600 hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                            </div>
                            <p><span class="font-bold">Hora:</span> ${event.start.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</p>
                            <p><span class="font-bold">Tipo:</span> ${event.type === 'recoleccion' ? 'Recolecci√≥n' : 'Entrega'}</p>
                            <p><span class="font-bold">Para:</span> ${client?.name || 'Cliente no encontrado'}</p>
                            <p><span class="font-bold">Transportista:</span> ${operator?.name || 'Sin asignar'}</p>
                            ${event.material ? `<p><span class="font-bold">Material:</span> ${event.material}</p>` : ''}
                            ${event.notes ? `<p class="mt-1 pt-1 border-t border-gray-200"><span class="font-bold">Nota:</span> <span class="text-gray-600 italic">${event.notes}</span></p>` : ''}
                        </div>`;
                }

                function renderGestionView() {
                    mainContent.innerHTML = `<div><div class="sm:hidden"><label for="tabs" class="sr-only">Selecciona una pesta√±a</label><select id="tabs" name="tabs" class="block w-full focus:ring-indigo-500 focus:border-indigo-500 border-gray-300 rounded-md"><option ${state.gestionView === 'clientes' ? 'selected' : ''} value="clientes">Clientes</option><option ${state.gestionView === 'operadores' ? 'selected' : ''} value="operadores">Operadores</option></select></div><div class="hidden sm:block"><div class="border-b border-gray-200"><nav class="-mb-px flex space-x-8" aria-label="Tabs"><button data-gestion-view="clientes" class="${state.gestionView === 'clientes' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Clientes</button><button data-gestion-view="operadores" class="${state.gestionView === 'operadores' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Operadores</button></nav></div></div></div><div id="gestion-content" class="mt-6"></div>`;
                    if(state.gestionView === 'clientes') { renderClientManager(); } else { renderOperatorManager(); }
                }

                function renderCrudManager(title, iconSVG, tableHTML, templateHandler, importHandler) {
                     const gestionContent = document.getElementById('gestion-content');
                     gestionContent.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg"><div class="flex justify-between items-center mb-6 flex-wrap gap-4"><div class="flex items-center">${iconSVG}<h2 class="text-2xl font-bold text-gray-700 ml-2">${title}</h2></div><div class="flex items-center gap-2"><button data-action="download-template" class="flex items-center bg-gray-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-gray-700 text-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>Plantilla</button><button data-action="import-csv" class="flex items-center bg-green-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-700 text-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>Importar CSV</button></div></div><div class="overflow-x-auto table-container">${tableHTML}</div></div>`;
                    const importInputId = title.includes('Clientes') ? 'import-clients-input' : 'import-operators-input';
                    gestionContent.querySelector('[data-action="download-template"]').onclick = templateHandler;
                    const fileInput = document.getElementById(importInputId);
                    gestionContent.querySelector('[data-action="import-csv"]').onclick = () => fileInput.click();
                    fileInput.onchange = importHandler;
                }

                function renderClientManager() {
                    const tableHTML = `<table class="min-w-full bg-white"><thead class="bg-gray-100"><tr><th class="text-left py-3 px-4 uppercase font-semibold text-sm text-gray-600">C√≥digo Tienda</th><th class="text-left py-3 px-4 uppercase font-semibold text-sm text-gray-600">Nombre</th><th class="text-left py-3 px-4 uppercase font-semibold text-sm text-gray-600 hidden md:table-cell">Direcci√≥n</th><th class="text-left py-3 px-4 uppercase font-semibold text-sm text-gray-600">Tel√©fono</th><th class="text-left py-3 px-4 uppercase font-semibold text-sm text-gray-600">Acciones</th></tr></thead><tbody>${state.clients.sort((a, b) => a.name.localeCompare(b.name)).map(client => `<tr class="border-b hover:bg-gray-50"><td class="py-3 px-4">${client.storeCode || 'N/A'}</td><td class="py-3 px-4">${client.name}</td><td class="py-3 px-4 hidden md:table-cell">${client.address || ''}</td><td class="py-3 px-4">${client.phone || ''}</td><td class="py-3 px-4 flex space-x-2"><button data-action="edit-client" data-id="${client.id}" class="text-blue-500 hover:text-blue-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button><button data-action="delete-client" data-id="${client.id}" class="text-red-500 hover:text-red-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></td></tr>`).join('') || `<tr><td colspan="5" class="text-center text-gray-500 py-8">No hay clientes.</td></tr>`}</tbody></table>`;
                    renderCrudManager('Gesti√≥n de Clientes', `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.975 5.975 0 0112 13a5.975 5.975 0 014.5 2.803M15 21a9 9 0 00-9-9" /></svg>`, tableHTML, handleDownloadClientTemplate, createImportHandler('clients'));
                }

                function renderOperatorManager() {
                     const tableHTML = `<table class="min-w-full bg-white"><thead class="bg-gray-100"><tr><th class="text-left py-3 px-4 uppercase font-semibold text-sm text-gray-600">Nombre</th><th class="text-left py-3 px-4 uppercase font-semibold text-sm text-gray-600">Tel√©fono</th><th class="text-left py-3 px-4 uppercase font-semibold text-sm text-gray-600 hidden sm:table-cell">Placa</th><th class="text-left py-3 px-4 uppercase font-semibold text-sm text-gray-600">Estatus</th><th class="text-left py-3 px-4 uppercase font-semibold text-sm text-gray-600">Acciones</th></tr></thead><tbody>${state.operators.sort((a,b) => a.name.localeCompare(b.name)).map(op => `<tr class="border-b hover:bg-gray-50"><td class="py-3 px-4">${op.name}</td><td class="py-3 px-4">${op.phone || ''}</td><td class="py-3 px-4 hidden sm:table-cell">${op.vehiclePlate || 'N/A'}</td><td class="py-3 px-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${op.status === 'activo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${op.status}</span></td><td class="py-3 px-4 flex space-x-2"><button data-action="edit-operator" data-id="${op.id}" class="text-blue-500 hover:text-blue-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button><button data-action="delete-operator" data-id="${op.id}" class="text-red-500 hover:text-red-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></td></tr>`).join('') || `<tr><td colspan="5" class="text-center text-gray-500 py-8">No hay operadores.</td></tr>`}</tbody></table>`;
                    renderCrudManager('Gesti√≥n de Operadores', `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10l2 2h8a1 1 0 001-1z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h2a1 1 0 001-1V7a1 1 0 00-1-1h-2" /></svg>`, tableHTML, handleDownloadOperatorTemplate, createImportHandler('operators'));
                }
                
                function renderModal(title, content, formId) {
                     modalContainer.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4 modal-overlay no-print"><div class="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col modal-content"><div class="flex justify-between items-center p-4 border-b"><h3 class="text-xl font-semibold text-gray-800">${title}</h3><button data-action="close-modal" class="text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="p-6 overflow-y-auto">${formId ? `<form id="${formId}">${content}</form>` : content}</div></div></div>`;
                }

                function renderConfirmModal(title, message, onConfirm) {
                    const content = `<p class="text-gray-600 mb-6">${message}</p><div class="flex justify-end space-x-3"><button type="button" data-action="close-modal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button><button id="confirm-action-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Confirmar</button></div>`;
                    renderModal(title, content, null);
                    document.getElementById('confirm-action-btn').addEventListener('click', () => { onConfirm(); modalContainer.innerHTML = ''; });
                }

                function renderNotesModal(title, content) { 
                    const modalContent = `<div class="text-sm text-gray-700 whitespace-pre-wrap break-words min-h-[100px]">${content}</div><div class="mt-6 flex justify-end"><button type="button" data-action="close-modal" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Cerrar</button></div>`;
                    renderModal(title, modalContent);
                }

                function renderClientForm(client = {}) {
                    state.editingItem = client;
                    const content = `<div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">C√≥digo de Tienda</label><input name="storeCode" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${client.storeCode || ''}" required></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label><input name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${client.name || ''}" required></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Direcci√≥n</label><input name="address" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${client.address || ''}" required></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label><input name="phone" type="tel" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${client.phone || ''}" required></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Correo (Opcional)</label><input name="email" type="email" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${client.email || ''}"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Notas</label><textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md">${client.notes || ''}</textarea></div><div class="flex justify-end space-x-3 pt-4"><button type="button" data-action="close-modal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Guardar</button></div></div>`;
                    renderModal(client.id ? "Editar Cliente" : "Nuevo Cliente", content, 'client-form');
                }

                function renderOperatorForm(operator = {}) {
                    state.editingItem = operator;
                    const content = `<div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label><input name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${operator.name || ''}" required></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label><input name="phone" type="tel" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${operator.phone || ''}" required></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Placa del Veh√≠culo</label><input name="vehiclePlate" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${operator.vehiclePlate || ''}"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Estatus</label><select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md"><option value="activo" ${operator.status === 'activo' ? 'selected' : ''}>Activo</option><option value="inactivo" ${operator.status === 'inactivo' ? 'selected' : ''}>Inactivo</option></select></div><div class="flex justify-end space-x-3 pt-4"><button type="button" data-action="close-modal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Guardar</button></div></div>`;
                    renderModal(operator.id ? "Editar Operador" : "Nuevo Operador", content, 'operator-form');
                }

                function renderEventForm(event = {}, date) {
                     state.editingItem = event;
                     const targetDate = event.start || date || new Date(); const d = new Date(targetDate); if (!event.start) d.setHours(9, 0, 0, 0); const dateString = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().substring(0, 16);
                     const content = `<div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label><select name="type" class="w-full px-3 py-2 border border-gray-300 rounded-md"><option value="recoleccion" ${event.type === 'recoleccion' ? 'selected' : ''}>Recolecci√≥n</option><option value="entrega" ${event.type === 'entrega' ? 'selected' : ''}>Entrega</option></select></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label><select name="clientId" class="w-full px-3 py-2 border border-gray-300 rounded-md" required><option value="" disabled selected>Seleccione un cliente</option>${state.clients.sort((a, b) => a.name.localeCompare(b.name)).map(c => `<option value="${c.id}" ${event.clientId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}</select></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Operador</label><select name="operatorId" class="w-full px-3 py-2 border border-gray-300 rounded-md"><option value="">Sin asignar</option>${state.operators.filter(o => o.status === 'activo').sort((a, b) => a.name.localeCompare(b.name)).map(o => `<option value="${o.id}" ${event.operatorId === o.id ? 'selected' : ''}>${o.name}</option>`).join('')}</select></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Fecha y Hora</label><input name="start" type="datetime-local" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${dateString}" required></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Material</label><input name="material" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${event.material || ''}"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Notas</label><textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md">${event.notes || ''}</textarea></div><div class="flex justify-end space-x-3 pt-4"><button type="button" data-action="close-modal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Guardar</button></div></div>`;
                    renderModal(event.id ? "Editar Evento" : "Nuevo Evento", content, 'event-form');
                }

                function downloadFile(filename, content, mimeType) {
                    const link = document.createElement("a"); const file = new Blob([`\uFEFF${content}`], { type: `${mimeType};charset=utf-8;` }); link.href = URL.createObjectURL(file); link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link);
                }

                function handleDownloadClientTemplate() {
                    const content = [['CODIGO_TIENDA', 'NOMBRE','DIRECCION','TELEFONO','EMAIL','NOTAS'], ['T-001', 'Cliente Ejemplo', 'Calle Falsa 123', '5511223344', 'cliente@email.com', 'Notas para el cliente']]; const csvContent = content.map(row => `"${row.join('","')}"`).join('\n') + '\n'; downloadFile("plantilla_clientes.csv", csvContent, "text/csv");
                }

                function handleDownloadOperatorTemplate() { 
                    const content = [['NOMBRE','TELEFONO','PLACA_VEHICULO'], ['Operador Ejemplo', '5599887766', 'XYZ-567']]; const csvContent = content.map(row => `"${row.join('","')}"`).join('\n') + '\n'; downloadFile("plantilla_operadores.csv", csvContent, "text/csv");
                }

                function handleDownloadGeneralTemplate() {
                    const content = [['FECHA','HORA','TIPO','CLIENTE_NOMBRE', 'CLIENTE_CODIGO_TIENDA','CLIENTE_DIRECCION','CLIENTE_TELEFONO','CLIENTE_EMAIL','CLIENTE_NOTAS','OPERADOR_NOMBRE','OPERADOR_TELEFONO','OPERADOR_PLACA','MATERIAL','NOTAS_EVENTO'],['28/06/2025','14:30','recoleccion','Cliente General Ejemplo', 'T-001','Avenida Siempreviva 742','5512345678','cliente@ejemplo.com','Notas del cliente','Operador General Ejemplo','5599887766','ABC-123','PET y Cart√≥n','Llamar al llegar.']];
                    const csvContent = content.map(row => `"${row.join('","')}"`).join('\n') + '\n'; downloadFile("plantilla_general.csv", csvContent, "text/csv");
                }

                const createImportHandler = (dataType) => (e) => {
                    const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
                    reader.onload = (event) => {
                        const text = event.target.result; const lines = text.split('\n').filter(line => line.trim() !== ''); const headers = lines[0].trim().toUpperCase().split(',').map(h => h.trim().replace(/"/g, '')); const rows = lines.slice(1);
                        try {
                            let importedCount = 0;
                            if (dataType === 'clients') {
                                rows.forEach(row => {
                                    const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)?.map(c => c ? c.replace(/"/g, '').trim() : '') || [];
                                    const rowData = {}; headers.forEach((header, i) => { rowData[header] = cols[i] || ''; });
                                    if (rowData['NOMBRE']) { state.clients.push({ id: `local_${Date.now()}_${Math.random()}`, storeCode: rowData['CODIGO_TIENDA'], name: rowData['NOMBRE'], address: rowData['DIRECCION'], phone: rowData['TELEFONO'], email: rowData['EMAIL'], notes: rowData['NOTAS'] }); importedCount++; }
                                });
                            } else if (dataType === 'operators') {
                                rows.forEach(row => {
                                    const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)?.map(c => c ? c.replace(/"/g, '').trim() : '') || [];
                                    if (cols[0]) { state.operators.push({ id: `local_${Date.now()}_${Math.random()}`, name: cols[0], phone: cols[1], vehiclePlate: cols[2], status: 'activo' }); importedCount++; }
                                });
                            }
                            updateFirestoreState(); showToast(`${importedCount} registros de ${dataType} importados.`);
                        } catch(err) { showToast(`Error al importar: ${err.message}`, 'error'); }
                    };
                    reader.readAsText(file, 'UTF-8'); e.target.value = '';
                };
                
                function handleImportAgenda(e) { 
                    const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
                    reader.onload = (event) => {
                        const text = event.target.result; const lines = text.split('\n').filter(line => line.trim() !== ''); const headers = lines[0].trim().toUpperCase().split(',').map(h => h.trim().replace(/"/g, '')); const dataRows = lines.slice(1);
                        let eventsAdded = 0, clientsAdded = 0, operatorsAdded = 0, errors = [];
                        dataRows.forEach((row, index) => {
                            const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)?.map(c => c ? c.replace(/"/g, '').trim() : '') || [];
                            const rowData = {}; headers.forEach((header, i) => { rowData[header.replace(/\s*\(.*\)/, '')] = cols[i] || ''; });
                            const { FECHA, HORA, TIPO, CLIENTE_NOMBRE, CLIENTE_CODIGO_TIENDA, CLIENTE_DIRECCION, CLIENTE_TELEFONO, CLIENTE_EMAIL, CLIENTE_NOTAS, OPERADOR_NOMBRE, OPERADOR_TELEFONO, OPERADOR_PLACA, MATERIAL, NOTAS_EVENTO } = rowData;
                            if (!CLIENTE_NOMBRE || !FECHA || !HORA) { errors.push(`Fila ${index + 2}: Faltan datos clave.`); return; }
                            const dateParts = FECHA.split('/'); if (dateParts.length !== 3) { errors.push(`Fila ${index + 2}: Fecha inv√°lida.`); return; }
                            // Assuming DD/MM/YYYY format
                            const eventDate = new Date(`${dateParts[2]}-${dateParts[1]}-${dateParts[0]}T${HORA}`);
                            if (isNaN(eventDate.getTime())) { errors.push(`Fila ${index + 2}: Fecha/hora inv√°lida.`); return; }
                            let client = state.clients.find(c => c.name.toLowerCase() === CLIENTE_NOMBRE.toLowerCase());
                            if (!client) {
                                client = { id: `local_${Date.now()}_${Math.random()}`, name: CLIENTE_NOMBRE, storeCode: CLIENTE_CODIGO_TIENDA, address: CLIENTE_DIRECCION, phone: CLIENTE_TELEFONO, email: CLIENTE_EMAIL, notes: CLIENTE_NOTAS };
                                state.clients.push(client); clientsAdded++;
                            }
                            let operator = null;
                            if (OPERADOR_NOMBRE) {
                                operator = state.operators.find(o => o.name.toLowerCase() === OPERADOR_NOMBRE.toLowerCase());
                                if(!operator) {
                                    operator = { id: `local_${Date.now()}_${Math.random()}`, name: OPERADOR_NOMBRE, phone: OPERADOR_TELEFONO, vehiclePlate: OPERADOR_PLACA, status: 'activo' };
                                    state.operators.push(operator); operatorsAdded++;
                                }
                            }
                            state.events.push({ id: `local_${Date.now()}_${Math.random()}`, start: eventDate, type: TIPO || 'recoleccion', clientId: client.id, operatorId: operator ? operator.id : '', material: MATERIAL, notes: NOTAS_EVENTO });
                            eventsAdded++;
                        });
                        updateFirestoreState();
                        let successMessage = `Importaci√≥n: ${eventsAdded} eventos.`;
                        if(clientsAdded > 0) successMessage += ` ${clientsAdded} clientes nuevos.`; if(operatorsAdded > 0) successMessage += ` ${operatorsAdded} operadores nuevos.`;
                        showToast(successMessage); if (errors.length > 0) { setTimeout(() => showToast(`${errors.length} filas con errores.`, 'error'), 1000); }
                    };
                    reader.readAsText(file, 'UTF-8'); e.target.value = '';
                }

                function getFilteredReportEvents() {
                    const now = new Date(); let startDate, endDate = new Date();
                    switch(state.reportDateRange) {
                        case 'last7days': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 6); break;
                        case 'last30days': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 29); break;
                        case 'thisYear': startDate = new Date(now.getFullYear(), 0, 1); break;
                        case 'custom': startDate = state.reportCustomStartDate ? new Date(state.reportCustomStartDate + 'T00:00:00') : null; endDate = state.reportCustomEndDate ? new Date(state.reportCustomEndDate + 'T23:59:59') : null; if (!startDate || !endDate) return []; break;
                        default: startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    }
                    if (state.reportDateRange !== 'custom') { startDate.setHours(0, 0, 0, 0); endDate.setHours(23, 59, 59, 999); }
                    return state.events.filter(event => new Date(event.start) >= startDate && new Date(event.start) <= endDate);
                }

                function renderReportsView() {
                    const filteredEvents = getFilteredReportEvents();
                    mainContent.innerHTML = `<div class="space-y-8"><div class="bg-white p-4 rounded-lg shadow-md"><div class="flex items-center justify-between flex-wrap gap-4"><h2 class="text-2xl font-bold text-gray-800">Reportes</h2><div class="flex items-center gap-4 flex-wrap" id="reports-filter"><select id="date-range-selector" class="p-2 border border-gray-300 rounded-md bg-white text-sm"><option value="last7days" ${state.reportDateRange === 'last7days' ? 'selected' : ''}>√öltimos 7 d√≠as</option><option value="last30days" ${state.reportDateRange === 'last30days' ? 'selected' : ''}>√öltimos 30 d√≠as</option><option value="thisYear" ${state.reportDateRange === 'thisYear' ? 'selected' : ''}>Este a√±o</option><option value="custom" ${state.reportDateRange === 'custom' ? 'selected' : ''}>Personalizado</option></select><div id="custom-date-range-picker" class="flex items-center gap-2 ${state.reportDateRange === 'custom' ? '' : 'hidden'}"><input type="date" id="report-start-date" value="${state.reportCustomStartDate}" class="p-2 border border-gray-300 rounded-md text-sm"><span>-</span><input type="date" id="report-end-date" value="${state.reportCustomEndDate}" class="p-2 border border-gray-300 rounded-md text-sm"></div></div></div></div><div id="report-kpis"></div><div class="grid grid-cols-1 lg:grid-cols-5 gap-8"><div class="bg-white p-6 rounded-lg shadow-md lg:col-span-3"><h3 class="text-xl font-bold text-gray-800 mb-4">Servicios por D√≠a</h3><canvas id="eventsOverTimeChart" class="max-h-80"></canvas></div><div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2"><h3 class="text-xl font-bold text-gray-800 mb-4">Clientes Principales</h3><canvas id="clientDistributionChart" class="max-h-80"></canvas></div><div class="bg-white p-6 rounded-lg shadow-md lg:col-span-5"><h3 class="text-xl font-bold text-gray-800 mb-4">Rendimiento por Operador</h3><canvas id="operatorPerformanceChart" class="max-h-80"></canvas></div></div><div id="report-data-table"></div></div>`;
                    renderReportKPIs(filteredEvents); renderReportDataTable(filteredEvents); generateChartData(filteredEvents);
                }

                function renderReportKPIs(events) {
                     const container = document.getElementById('report-kpis'); if (!container) return; const totalEvents = events.length; const clientCounts = events.reduce((acc, event) => { acc[event.clientId] = (acc[event.clientId] || 0) + 1; return acc; }, {}); const topClientId = Object.keys(clientCounts).sort((a,b) => clientCounts[b] - clientCounts[a])[0]; const topClient = state.clients.find(c => c.id === topClientId); const operatorCounts = events.reduce((acc, event) => { if (event.operatorId) acc[event.operatorId] = (acc[event.operatorId] || 0) + 1; return acc; }, {}); const topOperatorId = Object.keys(operatorCounts).sort((a,b) => operatorCounts[b] - operatorCounts[a])[0]; const topOperator = state.operators.find(o => o.id === topOperatorId);
                    container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="bg-white p-5 rounded-lg shadow-md flex items-center"><div class="bg-indigo-100 p-3 rounded-full"><svg class="h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg></div><div class="ml-4"><p class="text-sm text-gray-500">Total de Servicios</p><p class="text-2xl font-bold text-gray-800">${totalEvents}</p></div></div><div class="bg-white p-5 rounded-lg shadow-md flex items-center"><div class="bg-blue-100 p-3 rounded-full"><svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg></div><div class="ml-4"><p class="text-sm text-gray-500">Cliente Frecuente</p><p class="text-xl font-bold text-gray-800 truncate" title="${topClient?.name || 'N/A'}">${topClient?.name || 'N/A'}</p></div></div><div class="bg-white p-5 rounded-lg shadow-md flex items-center"><div class="bg-green-100 p-3 rounded-full"><svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10l2 2h8a1 1 0 001-1z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h2a1 1 0 001-1V7a1 1 0 00-1-1h-2" /></svg></div><div class="ml-4"><p class="text-sm text-gray-500">Operador Activo</p><p class="text-xl font-bold text-gray-800 truncate" title="${topOperator?.name || 'N/A'}">${topOperator?.name || 'N/A'}</p></div></div></div>`;
                }

                function renderReportDataTable(events) {
                    const container = document.getElementById('report-data-table'); if (!container) return; const page = state.reportTablePage, rowsPerPage = state.reportTableRowsPerPage; const totalPages = Math.ceil(events.length / rowsPerPage); const paginatedEvents = events.slice((page - 1) * rowsPerPage, page * rowsPerPage);
                    const tableRows = paginatedEvents.map(event => { const client = state.clients.find(c => c.id === event.clientId) || {}; const operator = state.operators.find(o => o.id === event.operatorId) || {}; return `<tr class="border-b hover:bg-gray-50 text-sm"><td class="p-3">${new Date(event.start).toLocaleDateString('es-ES')}</td><td class="p-3">${new Date(event.start).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}</td><td class="p-3">${event.type === 'recoleccion' ? 'Recolecci√≥n' : 'Entrega'}</td><td class="p-3">${client.name || 'N/A'}</td><td class="p-3 hidden md:table-cell">${operator.name || 'N/A'}</td><td class="p-3 hidden sm:table-cell">${event.material || 'N/A'}</td></tr>`; }).join('');
                    container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md"><div class="flex justify-between items-center mb-4 flex-wrap gap-2"><h3 class="text-xl font-bold text-gray-800">Detalle de Servicios</h3><button data-action="export-report-csv" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 text-sm flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> Exportar CSV</button></div><div class="overflow-x-auto table-container"><table class="min-w-full"><thead class="bg-gray-100"><tr><th class="text-left p-3 uppercase font-semibold text-xs text-gray-600">Fecha</th><th class="text-left p-3 uppercase font-semibold text-xs text-gray-600">Hora</th><th class="text-left p-3 uppercase font-semibold text-xs text-gray-600">Tipo</th><th class="text-left p-3 uppercase font-semibold text-xs text-gray-600">Cliente</th><th class="text-left p-3 uppercase font-semibold text-xs text-gray-600 hidden md:table-cell">Operador</th><th class="text-left p-3 uppercase font-semibold text-xs text-gray-600 hidden sm:table-cell">Material</th></tr></thead><tbody>${tableRows.length > 0 ? tableRows : `<tr><td colspan="6" class="text-center text-gray-500 py-8">No hay datos.</td></tr>`}</tbody></table></div><div class="flex justify-between items-center mt-4 text-sm"><p class="text-gray-600">Mostrando ${Math.min((page - 1) * rowsPerPage + 1, events.length)} a ${Math.min(page * rowsPerPage, events.length)} de ${events.length}</p><div class="flex gap-1"><button data-action="prev-report-page" class="p-2 rounded-md hover:bg-gray-100 ${page === 1 ? 'text-gray-300 cursor-not-allowed' : 'text-gray-600'}" ${page === 1 ? 'disabled' : ''}>&lt; Ant</button><button data-action="next-report-page" class="p-2 rounded-md hover:bg-gray-100 ${page >= totalPages ? 'text-gray-300 cursor-not-allowed' : 'text-gray-600'}" ${page >= totalPages ? 'disabled' : ''}>Sig &gt;</button></div></div></div>`;
                }

                function generateChartData(filteredEvents) {
                    renderEventsOverTimeChart(filteredEvents); renderOperatorPerformanceChart(filteredEvents); renderClientDistributionChart(filteredEvents);
                }

                function renderEventsOverTimeChart(events) {
                    const ctx = document.getElementById('eventsOverTimeChart')?.getContext('2d'); if (!ctx) return;
                    const eventCounts = events.reduce((acc, event) => { const day = new Date(event.start).toISOString().split('T')[0]; acc[day] = (acc[day] || 0) + 1; return acc; }, {}); const sortedLabels = Object.keys(eventCounts).sort();
                    activeCharts.eventsOverTime = new Chart(ctx, { type: 'line', data: { labels: sortedLabels, datasets: [{ label: 'Servicios por D√≠a', data: sortedLabels.map(label => eventCounts[label]), borderColor: 'rgb(79, 70, 229)', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'dd/MM' } }, grid: { display: false } }, y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } } });
                }

                function renderOperatorPerformanceChart(events) {
                    const ctx = document.getElementById('operatorPerformanceChart')?.getContext('2d'); if (!ctx) return;
                    const operatorStats = events.reduce((acc, event) => { if (!event.operatorId) return acc; if (!acc[event.operatorId]) { acc[event.operatorId] = { recoleccion: 0, entrega: 0, name: state.operators.find(o=>o.id === event.operatorId)?.name || 'Desconocido' }; } acc[event.operatorId][event.type]++; return acc; }, {}); const sortedOperators = Object.values(operatorStats).sort((a,b) => (b.recoleccion + b.entrega) - (a.recoleccion + a.entrega));
                    activeCharts.operatorPerformance = new Chart(ctx, { type: 'bar', data: { labels: sortedOperators.map(op => op.name), datasets: [ { label: 'Recolecciones', data: sortedOperators.map(op => op.recoleccion), backgroundColor: 'rgba(59, 130, 246, 0.7)' }, { label: 'Entregas', data: sortedOperators.map(op => op.entrega), backgroundColor: 'rgba(16, 185, 129, 0.7)' } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { position: 'top' } } } });
                }

                function renderClientDistributionChart(events) {
                    const ctx = document.getElementById('clientDistributionChart')?.getContext('2d'); if (!ctx) return;
                    const clientCounts = events.reduce((acc, event) => { if (event.clientId) { acc[event.clientId] = (acc[event.clientId] || 0) + 1; } return acc; }, {}); const topClients = Object.entries(clientCounts).sort(([,a],[,b]) => b - a).slice(0, 7);
                    activeCharts.clientDistribution = new Chart(ctx, { type: 'bar', data: { labels: topClients.map(([id]) => state.clients.find(c => c.id === id)?.name || 'Desconocido'), datasets: [{ label: 'Servicios por Cliente', data: topClients.map(([, count]) => count), backgroundColor: [ 'rgba(79, 70, 229, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(217, 70, 239, 0.7)' ], borderColor: '#fff', borderWidth: 1 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
                }

                function handleExportAgendaCSV() {
                    renderConfirmModal('Confirmar Exportaci√≥n', 'Se generar√° un archivo CSV con TODOS los datos de la agenda. ¬øDeseas continuar?', () => {
                        let csvContent = "FECHA,HORA,TIPO,CLIENTE,CODIGO_TIENDA,DIRECCION,OPERADOR,MATERIAL,NOTAS\n";
                        state.events.forEach(event => {
                            const client = state.clients.find(c => c.id === event.clientId) || {}; const operator = state.operators.find(o => o.id === event.operatorId) || {};
                            const row = [event.start.toLocaleDateString('es-ES'), event.start.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}), event.type, `"${client.name || ''}"`, `"${client.storeCode || ''}"`, `"${client.address || ''}"`, `"${operator.name || ''}"`, `"${event.material || ''}"`, `"${(event.notes || '').replace(/"/g, '""')}"`].join(',');
                            csvContent += row + '\n';
                        });
                        downloadFile('agenda_completa.csv', csvContent, 'text/csv;charset=utf-8;'); showToast('Exportaci√≥n a CSV completada.');
                    });
                }

                function handleExportAgendaICS() {
                     renderConfirmModal('Confirmar Exportaci√≥n', 'Se generar√° un archivo .ics para calendarios. ¬øDeseas continuar?', () => {
                        let icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//EcoAgenda//EN\n`;
                        state.events.forEach(event => {
                            const client = state.clients.find(c => c.id === event.clientId) || {}; const operator = state.operators.find(o => o.id === event.operatorId) || {}; const startTime = event.start; const endTime = new Date(startTime.getTime() + 60 * 60 * 1000); let description = `Operador: ${operator?.name || 'No asignado'}\\nMaterial: ${event.material || 'No especificado'}\\n`;
                            if (event.notes) description += `Notas Evento: ${event.notes}\\n`; if (client?.notes) description += `\\n--- NOTAS CLIENTE ---\\n${client.notes}`;
                            icsContent += 'BEGIN:VEVENT\n'; icsContent += `UID:${event.id}@ecoagenda.com\n`; icsContent += `DTSTAMP:${formatICSDate(new Date())}\n`; icsContent += `DTSTART:${formatICSDate(startTime)}\n`; icsContent += `DTEND:${formatICSDate(endTime)}\n`; icsContent += `SUMMARY:${event.type === 'recoleccion' ? 'Recolecci√≥n' : 'Entrega'}: ${client.name}\n`; icsContent += `DESCRIPTION:${description.replace(/\n/g, '\\n')}\n`; icsContent += `LOCATION:${client.address || ''}\n`; icsContent += 'END:VEVENT\n';
                        });
                        icsContent += 'END:VCALENDAR'; downloadFile('EcoAgenda.ics', icsContent, 'text/calendar'); showToast('Exportaci√≥n a .ics completada.');
                    });
                }

                function handleExportReportCSV() {
                    const eventsToExport = getFilteredReportEvents(); if (eventsToExport.length === 0) { showToast("No hay datos para exportar.", "error"); return; }
                    let csvContent = "FECHA,HORA,TIPO,CLIENTE,DIRECCION,OPERADOR,MATERIAL,NOTAS_EVENTO\n";
                    eventsToExport.forEach(event => { const client = state.clients.find(c => c.id === event.clientId) || {}; const operator = state.operators.find(o => o.id === event.operatorId) || {}; const row = [ new Date(event.start).toLocaleDateString('es-ES'), new Date(event.start).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}), event.type, `"${client.name||''}"`, `"${client.address||''}"`, `"${operator.name||''}"`, `"${event.material||''}"`, `"${(event.notes||'').replace(/"/g,'""')}"` ].join(','); csvContent += row + '\n'; });
                    downloadFile(`reporte_ecoagenda_${new Date().toISOString().split('T')[0]}.csv`, csvContent, 'text/csv;charset=utf-8;'); showToast('Reporte exportado a CSV.');
                }
                
                document.body.addEventListener('click', (e) => {
                    const target = e.target.closest('[data-action],[data-view],[data-calendar-view],[data-gestion-view]');
                    if (!target) {
                        const dropdown = document.getElementById('io-dropdown-menu');
                        if (dropdown && !dropdown.classList.contains('hidden') && !e.target.closest('#io-dropdown-container')) { dropdown.classList.add('hidden'); }
                        return;
                    };
                    const { action, view, calendarView, gestionView } = target.dataset;
                    if (view) {
                        e.preventDefault(); state.currentView = view; document.querySelectorAll('#main-nav .nav-btn').forEach(btn => { btn.classList.remove('bg-indigo-600', 'text-white'); btn.classList.add('text-gray-600', 'hover:bg-gray-200'); });
                        target.classList.add('bg-indigo-600', 'text-white'); target.classList.remove('text-gray-600', 'hover:bg-gray-200'); render();
                    }
                    if (calendarView) { state.calendarView = calendarView; renderAgendaView(); }
                    if (gestionView) { state.gestionView = gestionView; renderGestionView(); }
                    if (!action) return;
                    if (target.closest('#io-dropdown-menu')) { e.preventDefault(); setTimeout(() => { const menu = document.getElementById('io-dropdown-menu'); if(menu) menu.classList.add('hidden'); }, 100); }
                    switch(action) {
                        case 'toggle-io-dropdown': document.getElementById('io-dropdown-menu').classList.toggle('hidden'); break;
                        case 'close-modal': modalContainer.innerHTML = ''; state.editingItem = null; break;
                        case 'prev-period': if (state.calendarView === 'day') state.currentDate.setDate(state.currentDate.getDate() - 1); else if (state.calendarView === 'week') state.currentDate.setDate(state.currentDate.getDate() - 7); else state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderAgendaView(); break;
                        case 'next-period': if (state.calendarView === 'day') state.currentDate.setDate(state.currentDate.getDate() + 1); else if (state.calendarView === 'week') state.currentDate.setDate(state.currentDate.getDate() + 7); else state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderAgendaView(); break;
                        case 'today': state.currentDate = new Date(); renderAgendaView(); break;
                        case 'add-event': renderEventForm({}, new Date(target.dataset.date)); break;
                        case 'edit-event': renderEventForm(state.events.find(ev => ev.id === target.dataset.eventId)); break;
                        case 'delete-event-month': e.stopPropagation(); renderConfirmModal('Eliminar Evento', '¬øSeguro que quieres eliminar este evento?', () => { state.events = state.events.filter(ev => ev.id !== target.dataset.eventId); updateFirestoreState(); }); break;
                        case 'delete-event': renderConfirmModal('Eliminar Evento', '¬øSeguro que quieres eliminar este evento?', () => { state.events = state.events.filter(ev => ev.id !== target.dataset.eventId); updateFirestoreState(); }); break;
                        case 'edit-client': renderClientForm(state.clients.find(c => c.id === target.dataset.id)); break;
                        case 'delete-client': renderConfirmModal('Eliminar Cliente', '¬øEliminar este cliente y todos sus eventos?', () => { state.clients = state.clients.filter(c => c.id !== target.dataset.id); state.events = state.events.filter(e => e.clientId !== target.dataset.id); updateFirestoreState(); showToast('Cliente eliminado.'); }); break;
                        case 'edit-operator': renderOperatorForm(state.operators.find(o => o.id === target.dataset.id)); break;
                        case 'delete-operator': renderConfirmModal('Eliminar Operador', '¬øEliminar este operador? (No se borrar√°n sus eventos asignados)', () => { state.operators = state.operators.filter(o => o.id !== target.dataset.id); updateFirestoreState(); showToast('Operador eliminado.'); }); break;
                        case 'show-notes': const client = state.clients.find(c => c.id === target.dataset.clientId); if (client) { renderNotesModal(`Notas para: ${client.name}`, client.notes || 'No hay notas para este cliente.'); }; break;
                        case 'add-to-calendar':
                            const event = state.events.find(e => e.id === target.dataset.eventId);
                            if(event) {
                                const client = state.clients.find(c => c.id === event.clientId) || {};
                                const startTime = event.start;
                                const endTime = new Date(startTime.getTime() + 60 * 60 * 1000);
                                const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(`${event.type}: ${client.name}`)}&dates=${formatDateForGoogle(startTime)}/${formatDateForGoogle(endTime)}&details=${encodeURIComponent(event.notes || '')}&location=${encodeURIComponent(client.address || '')}`;
                                window.open(googleCalendarUrl, '_blank');
                            }
                            break;
                        case 'export-agenda-csv': handleExportAgendaCSV(); break; 
                        case 'export-agenda-ics': handleExportAgendaICS(); break; 
                        case 'print-view': window.print(); break; 
                        case 'download-general-template': handleDownloadGeneralTemplate(); break; 
                        case 'download-template': (state.gestionView === 'clientes' ? handleDownloadClientTemplate : handleDownloadOperatorTemplate)(); break;
                        case 'import-agenda': document.getElementById('import-agenda-input').click(); break;
                        case 'import-csv': document.getElementById(state.gestionView === 'clientes' ? 'import-clients-input' : 'import-operators-input').click(); break;
                        case 'export-report-csv': handleExportReportCSV(); break;
                        case 'prev-report-page': if (state.reportTablePage > 1) { state.reportTablePage--; renderReportDataTable(getFilteredReportEvents()); } break;
                        case 'next-report-page': const events = getFilteredReportEvents(); const totalPages = Math.ceil(events.length / state.reportTableRowsPerPage); if (state.reportTablePage < totalPages) { state.reportTablePage++; renderReportDataTable(events); } break;
                    }
                });
                
                // Drag and Drop listeners
                mainContent.addEventListener('dragstart', e => { if (e.target.matches('.month-event')) { e.dataTransfer.setData('text/plain', e.target.dataset.eventId); e.target.classList.add('dragging'); } });
                mainContent.addEventListener('dragend', e => { if (e.target.matches('.month-event')) { e.target.classList.remove('dragging'); } });
                mainContent.addEventListener('dragover', e => { const dayCell = e.target.closest('.day-cell-month'); if (dayCell) { e.preventDefault(); dayCell.classList.add('drag-over'); } });
                mainContent.addEventListener('dragleave', e => { const dayCell = e.target.closest('.day-cell-month'); if (dayCell) { dayCell.classList.remove('drag-over'); } });
                mainContent.addEventListener('drop', e => {
                    e.preventDefault(); const dayCell = e.target.closest('.day-cell-month');
                    if (dayCell) {
                        dayCell.classList.remove('drag-over'); const eventId = e.dataTransfer.getData('text/plain'); const newDateISO = dayCell.dataset.date; const eventToMove = state.events.find(ev => ev.id === eventId);
                        if (eventToMove) {
                            const oldDate = new Date(eventToMove.start); const newDate = new Date(newDateISO); newDate.setHours(oldDate.getHours(), oldDate.getMinutes(), oldDate.getSeconds()); eventToMove.start = newDate;
                            updateFirestoreState(); showToast('Evento movido.');
                        }
                    }
                });
                
                mainContent.addEventListener('change', e => {
                    if (e.target.id === 'date-range-selector') {
                        state.reportDateRange = e.target.value; state.reportTablePage = 1; const customPicker = document.getElementById('custom-date-range-picker');
                        if (e.target.value === 'custom') { customPicker?.classList.remove('hidden'); } else { customPicker?.classList.add('hidden'); renderReportsView(); }
                    }
                     if (e.target.id === 'report-start-date' || e.target.id === 'report-end-date') {
                        state.reportCustomStartDate = document.getElementById('report-start-date').value; state.reportCustomEndDate = document.getElementById('report-end-date').value;
                         if(state.reportCustomStartDate && state.reportCustomEndDate) { state.reportTablePage = 1; renderReportsView(); }
                    }
                    if (e.target.id === 'tabs') { state.gestionView = e.target.value; renderGestionView(); }
                });
                
                document.getElementById('add-new-btn-floating').onclick = () => {
                    state.editingItem = null;
                    if (state.currentView === 'agenda') renderEventForm({}, state.currentDate); else if (state.gestionView === 'clientes') renderClientForm(); else renderOperatorForm();
                };

                modalContainer.addEventListener('submit', (e) => {
                    e.preventDefault(); const formData = new FormData(e.target); const data = Object.fromEntries(formData.entries()); const id = state.editingItem?.id; const newId = () => `local_${Date.now()}_${Math.random()}`;
                    if (e.target.id === 'client-form') { if(id) { state.clients = state.clients.map(c => c.id === id ? { ...c, ...data } : c); } else { state.clients.push({ id: newId(), ...data }); } }
                    else if (e.target.id === 'operator-form') { if(id) { state.operators = state.operators.map(o => o.id === id ? { ...o, ...data } : o); } else { state.operators.push({ id: newId(), ...data, status: 'activo' }); } }
                    else if (e.target.id === 'event-form') { const eventData = { ...data, start: new Date(data.start) }; if(id) { state.events = state.events.map(ev => ev.id === id ? { ...ev, ...eventData } : ev); } else { state.events.push({ id: newId(), ...eventData }); } }
                    updateFirestoreState(); modalContainer.innerHTML = ''; state.editingItem = null;
                });
                
                document.getElementById('import-agenda-input').onchange = handleImportAgenda;
                document.getElementById('import-clients-input').onchange = createImportHandler('clients');
                document.getElementById('import-operators-input').onchange = createImportHandler('operators');

            }); // End DOMContentLoaded
        } catch (error) {
            console.error("‚ùå Error CR√çTICO al inicializar Firebase:", error);
            loadingMessage.textContent = "Error CR√çTICO de Firebase. Revisa la consola.";
        }
    </script>
</body>
</html>
